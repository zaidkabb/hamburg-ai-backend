<!DOCTYPE html>
<html>
<head>
    <title>Hamburg AI Assistant - WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        #chatBox {
            border: 1px solid #ccc;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        #messageInput {
            width: 80%;
            padding: 10px;
            font-size: 16px;
        }
        #sendButton {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .user {
            background: #e3f2fd;
            text-align: right;
        }
        .assistant {
            background: #f5f5f5;
        }
        .status {
            color: #666;
            font-style: italic;
            font-size: 12px;
        }
    </style>
</head>
<body>
<h1>Hamburg AI Assistant - WebSocket Streaming Test</h1>

<div id="status" class="status">Connecting...</div>

<div id="chatBox"></div>

<input type="text" id="messageInput" placeholder="Ask about Hamburg..." />
<button id="sendButton">Send</button>

<script>
    const chatBox = document.getElementById('chatBox');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const statusDiv = document.getElementById('status');

    let ws;
    let currentResponse = '';

    function connect() {
        ws = new WebSocket('ws://localhost:8080/ws/chat');

        ws.onopen = () => {
            statusDiv.textContent = 'Connected âœ“';
            statusDiv.style.color = 'green';
            sendButton.disabled = false;
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'connected') {
                addMessage('System', data.message, 'status');
            } else if (data.type === 'token') {
                // Append token to current response
                currentResponse += data.content;
                updateLastMessage(currentResponse);
            } else if (data.type === 'complete') {
                currentResponse = '';
            } else if (data.type === 'error') {
                addMessage('Error', data.message, 'status');
            }
        };

        ws.onerror = (error) => {
            console.error('WebSocket error:', error);
            statusDiv.textContent = 'Error!';
            statusDiv.style.color = 'red';
        };

        ws.onclose = () => {
            statusDiv.textContent = 'Disconnected';
            statusDiv.style.color = 'red';
            sendButton.disabled = true;
        };
    }

    function addMessage(sender, content, className = '') {
        const div = document.createElement('div');
        div.className = `message ${className}`;
        div.innerHTML = `<strong>${sender}:</strong> ${content}`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
        return div;
    }

    function updateLastMessage(content) {
        const messages = chatBox.getElementsByClassName('message');
        if (messages.length > 0) {
            const lastMessage = messages[messages.length - 1];
            if (lastMessage.classList.contains('assistant')) {
                lastMessage.innerHTML = `<strong>Assistant:</strong> ${content}`;
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }
    }

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        addMessage('You', message, 'user');
        addMessage('Assistant', '', 'assistant'); // Placeholder for streaming response
        currentResponse = '';

        ws.send(JSON.stringify({
            message: message,
            sessionId: 'test-session'
        }));

        messageInput.value = '';
    }

    sendButton.onclick = sendMessage;
    messageInput.onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
    };

    // Connect on page load
    connect();
</script>
</body>
</html>